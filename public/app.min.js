let state={currentDate:new Date,currentLocation:"jhb",locations:[],teams:[],bookings:[],publicHolidays:[],selectedDate:null,viewers:[],myName:null,myUserId:null,currentRoom:null,weatherCache:{}},socket=null;const elements={locationSelect:document.getElementById("locationSelect"),capacityLabel:document.getElementById("capacityLabel"),capacityFill:document.getElementById("capacityFill"),currentMonth:document.getElementById("currentMonth"),calendarGrid:document.getElementById("calendarGrid"),bookingModal:document.getElementById("bookingModal"),bookingForm:document.getElementById("bookingForm"),teamSelect:document.getElementById("teamSelect"),teamModal:document.getElementById("teamModal"),teamForm:document.getElementById("teamForm"),locationModal:document.getElementById("locationModal"),locationForm:document.getElementById("locationForm"),toastContainer:document.getElementById("toastContainer")};async function init(){loadTheme(),await loadData(),setupEventListeners(),renderCalendar(),updateCapacityDisplay(),initSocket(),fetchWeatherForLocation(state.currentLocation).then(()=>{renderCalendar()})}const WEATHER_ICONS={0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üåßÔ∏è",53:"üåßÔ∏è",55:"üåßÔ∏è",56:"üå®Ô∏è",57:"üå®Ô∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",66:"üå®Ô∏è",67:"üå®Ô∏è",71:"‚ùÑÔ∏è",73:"‚ùÑÔ∏è",75:"‚ùÑÔ∏è",77:"‚ùÑÔ∏è",80:"üå¶Ô∏è",81:"üå¶Ô∏è",82:"üåßÔ∏è",85:"üå®Ô∏è",86:"üå®Ô∏è",95:"‚õàÔ∏è",96:"‚õàÔ∏è",99:"‚õàÔ∏è"};async function geocodeAddress(e){if(!e)return null;try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&limit=1`,{headers:{"User-Agent":"OfficeBookingSystem/1.0"}}),n=await t.json();if(n&&n.length>0)return{lat:parseFloat(n[0].lat),lon:parseFloat(n[0].lon)}}catch(e){console.error("Geocoding error:",e)}return null}async function fetchWeatherForLocation(e){const t=state.locations.find(t=>t.id===e);if(!t||!t.address)return null;const n=state.weatherCache[e];if(n&&n.fetchedAt&&Date.now()-n.fetchedAt<36e5)return n.forecast;let o=n?.coords;if(!o&&(o=await geocodeAddress(t.address),!o))return null;try{const t=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${o.lat}&longitude=${o.lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=14`),n=await t.json();if(n&&n.daily){const t=n.daily.time.map((e,t)=>({date:e,weatherCode:n.daily.weather_code[t],tempMax:Math.round(n.daily.temperature_2m_max[t]),tempMin:Math.round(n.daily.temperature_2m_min[t])}));return state.weatherCache[e]={coords:o,forecast:t,fetchedAt:Date.now()},t}}catch(e){console.error("Weather fetch error:",e)}return null}function getWeatherIcon(e){return WEATHER_ICONS[e]||"üå°Ô∏è"}const WEATHER_DESCRIPTIONS={0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",45:"Fog",48:"Depositing rime fog",51:"Light drizzle",53:"Moderate drizzle",55:"Dense drizzle",56:"Light freezing drizzle",57:"Dense freezing drizzle",61:"Slight rain",63:"Moderate rain",65:"Heavy rain",66:"Light freezing rain",67:"Heavy freezing rain",71:"Slight snow",73:"Moderate snow",75:"Heavy snow",77:"Snow grains",80:"Slight rain showers",81:"Moderate rain showers",82:"Violent rain showers",85:"Slight snow showers",86:"Heavy snow showers",95:"Thunderstorm",96:"Thunderstorm with slight hail",99:"Thunderstorm with heavy hail"};function getWeatherDescription(e){return WEATHER_DESCRIPTIONS[e]||"Unknown"}function showWeatherTooltip(e,t){const n=parseInt(t.dataset.weatherCode),o=t.dataset.tempMax,a=t.dataset.tempMin,s=getWeatherDescription(n),d=getWeatherIcon(n);let l=document.getElementById("weatherTooltip");l||(l=document.createElement("div"),l.id="weatherTooltip",l.className="weather-tooltip",document.body.appendChild(l)),l.innerHTML=`\n        <div class="weather-tooltip-icon">${d}</div>\n        <div class="weather-tooltip-info">\n            <div class="weather-tooltip-desc">${s}</div>\n            <div class="weather-tooltip-temps">\n                <span class="temp-high">‚Üë ${o}¬∞C</span>\n                <span class="temp-low">‚Üì ${a}¬∞C</span>\n            </div>\n        </div>\n    `;const i=t.getBoundingClientRect();l.style.left=`${i.left+i.width/2}px`,l.style.top=i.top-8+"px",l.classList.add("visible")}function hideWeatherTooltip(){const e=document.getElementById("weatherTooltip");e&&e.classList.remove("visible")}function getWeatherForDate(e){const t=state.weatherCache[state.currentLocation];if(!t||!t.forecast)return null;return t.forecast.find(t=>t.date===e)}function initSocket(){state.myName=localStorage.getItem("userName"),state.myName||(state.myName=prompt("Enter your name for live presence:")||"Anonymous",localStorage.setItem("userName",state.myName)),socket=io(),socket.on("connect",()=>{console.log("Connected to real-time server"),joinCurrentRoom()}),socket.on("presence:update",({roomKey:e,viewers:t})=>{state.viewers=t,renderViewers()}),socket.on("data:changed",({type:e,booking:t,before:n})=>{if(console.log("Received data:changed",e,t),"booking:created"===e&&t){if(t.locationId===state.currentLocation){state.bookings.find(e=>e.id===t.id)||(state.bookings.push(t),renderCalendar(),updateCapacityDisplay(),showToast(`${t.teamName} booked by another user`,"success"))}}else if("booking:updated"===e&&t){const e=state.bookings.findIndex(e=>e.id===t.id);-1!==e?(state.bookings[e]=t,renderCalendar(),updateCapacityDisplay(),showToast(`${t.teamName} updated`,"success")):t.locationId===state.currentLocation&&(state.bookings.push(t),renderCalendar(),updateCapacityDisplay())}else if("booking:moved_out"===e&&t)state.bookings=state.bookings.filter(e=>e.id!==t.id),renderCalendar(),updateCapacityDisplay();else if("booking:deleted"===e&&t){const e=state.bookings.some(e=>e.id===t.id);state.bookings=state.bookings.filter(e=>e.id!==t.id),e&&(renderCalendar(),updateCapacityDisplay(),showToast(`${t.teamName} removed`,"success"))}}),socket.on("disconnect",()=>{console.log("Disconnected from real-time server"),state.viewers=[],renderViewers()})}function joinCurrentRoom(){if(!socket||!socket.connected)return;const e=state.currentDate.getFullYear(),t=String(state.currentDate.getMonth()+1).padStart(2,"0"),n=`presence:${state.currentLocation}:${e}-${t}`;state.currentRoom&&state.currentRoom!==n&&socket.emit("presence:leave",{roomKey:state.currentRoom}),state.myUserId||(state.myUserId="user-"+Math.random().toString(36).substr(2,9)),socket.emit("presence:join",{roomKey:n,user:{id:state.myUserId,name:state.myName}}),state.currentRoom=n}function renderViewers(){const e=document.getElementById("presenceAvatars"),t=document.getElementById("presenceCount");if(!e||!t)return;const n=state.viewers.length;t.textContent=n;const o=state.viewers.filter(e=>e.name!==state.myName);if(0===o.length)return void(e.innerHTML='<span class="presence-only-you">Only you</span>');const a=o.slice(0,5),s=o.length-5;let d=a.map(e=>`\n        <div class="presence-avatar" title="${e.name}" style="background: ${stringToColor(e.name)}">\n            ${getInitials(e.name)}\n        </div>\n    `).join("");s>0&&(d+=`<div class="presence-avatar presence-more" title="${s} more">+${s}</div>`),e.innerHTML=d}function stringToColor(e){let t=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n)+((t<<5)-t);return`hsl(${t%360}, 65%, 45%)`}function loadTheme(){const e=localStorage.getItem("theme")||"dark";document.documentElement.setAttribute("data-theme",e)}function toggleTheme(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("theme",e)}async function loadData(){try{const e=await fetch("/api/data"),t=await e.json();state.locations=t.locations||[],state.teams=t.teams||[],state.bookings=t.bookings||[],state.publicHolidays=t.publicHolidays||[],state.locations.length>0&&!state.locations.find(e=>e.id===state.currentLocation)&&(state.currentLocation=state.locations[0].id),renderLocationSelect(),renderTeamSelect(),renderTeamsList(),renderLocationsList(),renderHolidaysList(),renderHolidayYearSelect()}catch(e){console.error("Failed to load data:",e),showToast("Failed to load data","error")}}function setupEventListeners(){document.querySelectorAll(".nav-item[data-view]").forEach(e=>{e.addEventListener("click",()=>switchView(e.dataset.view))}),setupSettingsSubmenu(),document.getElementById("prevMonth").addEventListener("click",()=>navigateMonth(-1)),document.getElementById("nextMonth").addEventListener("click",()=>navigateMonth(1)),document.getElementById("todayBtn").addEventListener("click",goToToday),document.addEventListener("keydown",e=>{if("INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&"SELECT"!==e.target.tagName&&document.getElementById("calendarView").classList.contains("active"))switch(e.key){case"ArrowLeft":navigateMonth(-1),e.preventDefault();break;case"ArrowRight":navigateMonth(1),e.preventDefault();break;case"t":case"T":goToToday(),e.preventDefault()}}),elements.locationSelect.addEventListener("change",e=>{state.currentLocation=e.target.value,renderCalendar(),updateCapacityDisplay(),renderTeamSelect(),joinCurrentRoom(),fetchWeatherForLocation(state.currentLocation).then(()=>{renderCalendar()}),document.getElementById("desksView").classList.contains("active")&&(updateFloorSelector(),loadDesks())}),elements.bookingForm.addEventListener("submit",handleBookingSubmit),elements.teamSelect.addEventListener("change",handleTeamSelect),elements.teamForm.addEventListener("submit",handleTeamSubmit),document.getElementById("addTeamBtn").addEventListener("click",()=>{renderTeamLocationSelect(),elements.teamModal.classList.add("active")}),elements.locationForm.addEventListener("submit",handleLocationSubmit),document.getElementById("addLocationBtn").addEventListener("click",()=>{elements.locationModal.classList.add("active")}),document.getElementById("fetchHolidaysBtn").addEventListener("click",fetchHolidays),document.getElementById("themeToggle").addEventListener("click",toggleTheme),document.getElementById("mobileThemeToggle")?.addEventListener("click",toggleTheme);const e=document.getElementById("mobileMenuBtn"),t=document.getElementById("mobileOverlay"),n=document.getElementById("sidebar");e?.addEventListener("click",()=>{n?.classList.toggle("open"),t?.classList.toggle("active"),document.body.classList.toggle("menu-open")}),t?.addEventListener("click",()=>{n?.classList.remove("open"),t?.classList.remove("active"),document.body.classList.remove("menu-open")}),document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",()=>{n?.classList.remove("open"),t?.classList.remove("active"),document.body.classList.remove("menu-open")})}),[elements.bookingModal,elements.teamModal,elements.locationModal].forEach(e=>{e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(closeModal(),closeTeamModal(),closeLocationModal())})}function renderCalendar(){const e=state.currentDate.getFullYear(),t=state.currentDate.getMonth();elements.currentMonth.textContent=`${["January","February","March","April","May","June","July","August","September","October","November","December"][t]} ${e}`;const n=new Date(e,t,1),o=new Date(e,t+1,0),a=(n.getDay()+6)%7,s=o.getDate(),d=state.bookings.filter(n=>{const o=new Date(n.date);return o.getFullYear()===e&&o.getMonth()===t&&n.locationId===state.currentLocation}),l=state.locations.find(e=>e.id===state.currentLocation),i=l?l.capacity:21;let c="";const r=new Date,m=new Date(e,t,0).getDate();for(let e=a-1;e>=0;e--){c+=`<div class="calendar-day other-month"><span class="day-number">${m-e}</span></div>`}for(let n=1;n<=s;n++){const o=new Date(e,t,n),a=formatDateStr(o),s=o.getDay(),l=0===s||6===s,m=o.toDateString()===r.toDateString(),u=state.publicHolidays.find(e=>e.date===a),g=d.filter(e=>e.date===a),p=g.reduce((e,t)=>e+getBookingPeopleCount(t),0);let h=["calendar-day"];l&&h.push("weekend"),m&&h.push("today"),u&&h.push("holiday");let y=`<span class="day-number">${n}</span>`;const v=getWeatherForDate(a),k=formatDateStr(r);if(v&&a>=k){getWeatherDescription(v.weatherCode);y+=`<span class="day-weather" \n                data-weather-code="${v.weatherCode}"\n                data-temp-max="${v.tempMax}"\n                data-temp-min="${v.tempMin}"\n                onmouseenter="showWeatherTooltip(event, this)"\n                onmouseleave="hideWeatherTooltip()">${getWeatherIcon(v.weatherCode)}</span>`}if(!l&&!u&&p>0){let e="";p>=i?e="full":p>=.8*i&&(e="warning"),y+=`<span class="day-capacity ${e}">${p}/${i}</span>`}if(u&&(y+=`<span class="holiday-label">${u.name}</span>`),!l&&!u&&g.length>0){y+='<div class="day-bookings-preview">';const e=5,t=[...g].sort((e,t)=>{const n=state.teams.find(t=>t.id===e.teamId),o=state.teams.find(e=>e.id===t.teamId),a=n?n.name:e.teamName||"",s=o?o.name:t.teamName||"";return a.localeCompare(s)});t.slice(0,e).forEach(e=>{const t=state.teams.find(t=>t.id===e.teamId),n=t?t.color:"#6B7280",o=t?t.id:"",a=t?t.name:e.teamName,s=t?t.memberCount:e.peopleCount;y+=`\n                    <div class="booking-chip" \n                         draggable="true"\n                         data-booking-id="${e.id}"\n                         data-team-id="${o}"\n                         style="background: ${n};"\n                         ondragstart="handleDragStart(event, this.dataset.bookingId)"\n                         ondragend="handleDragEnd(event)"\n                         onmouseenter="showTeamTooltip(event, this.dataset.teamId)"\n                         onmouseleave="hideTeamTooltip()">\n                        <span>${a}</span>\n                        <span style="opacity: 0.8">(${s})</span>\n                    </div>\n                `}),t.length>e&&(y+=`<span class="more-bookings">+${t.length-e} more</span>`),y+="</div>"}const f=l||u?"":`onclick="openBookingModal('${a}')"`,I=l||u?"":`\n            ondragover="handleDragOver(event)"\n            ondragleave="handleDragLeave(event)"\n            ondrop="handleDrop(event, '${a}')"\n        `,E=g.length;c+=`<div class="${h.join(" ")}" ${f} ${I} data-date="${a}" data-booking-count="${E}">${y}</div>`}const u=(7-(a+s)%7)%7;for(let e=1;e<=u;e++)c+=`<div class="calendar-day other-month"><span class="day-number">${e}</span></div>`;elements.calendarGrid.innerHTML=c,renderCalendarList(e,t,d,i,r)}function renderCalendarList(e,t,n,o,a){const s=document.getElementById("calendarList");if(!s)return;const d=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],l=new Date(e,t+1,0).getDate(),i=formatDateStr(a);let c="";for(let s=1;s<=l;s++){const l=new Date(e,t,s),r=formatDateStr(l),m=l.getDay(),u=0===m||6===m,g=l.toDateString()===a.toDateString(),p=state.publicHolidays.find(e=>e.date===r);if(u)continue;const h=n.filter(e=>e.date===r),y=h.reduce((e,t)=>e+getBookingPeopleCount(t),0);let v=["calendar-list-day"];g&&v.push("today"),p&&v.push("holiday");let k="";y>=o?k="full":y>=.8*o&&(k="warning");const f=getWeatherForDate(r),I=f&&r>=i?`<span class="calendar-list-weather">${getWeatherIcon(f.weatherCode)}</span>`:"";let E="";if(p)E=`<div class="calendar-list-holiday">${p.name}</div>`;else if(h.length>0){const e=[...h].sort((e,t)=>{const n=state.teams.find(t=>t.id===e.teamId),o=state.teams.find(e=>e.id===t.teamId);return(n?.name||"").localeCompare(o?.name||"")});E='<div class="calendar-list-bookings">',e.forEach(e=>{const t=state.teams.find(t=>t.id===e.teamId),n=t?t.color:"#6B7280",o=t?t.name:e.teamName,a=t?t.memberCount:e.peopleCount,s=t?.managerImage,d=t?.manager||"";let l="";if(s)l=`<img src="${s}" alt="${d}" class="calendar-list-booking-avatar" loading="lazy">`;else{l=`<div class="calendar-list-booking-avatar" style="background: ${n}">${getInitials(d)}</div>`}E+=`\n                    <div class="calendar-list-booking" onclick="openBookingModal('${r}')">\n                        ${l}\n                        <div class="calendar-list-booking-color" style="background: ${n}"></div>\n                        <div class="calendar-list-booking-info">\n                            <span class="calendar-list-booking-team">${o}</span>\n                            <span class="calendar-list-booking-count">${a} people</span>\n                        </div>\n                    </div>\n                `}),E+="</div>"}else E=`<div class="calendar-list-empty" onclick="openBookingModal('${r}')">No bookings - tap to add</div>`;c+=`\n            <div class="${v.join(" ")}">\n                <div class="calendar-list-header" onclick="openBookingModal('${r}')">\n                    <div class="calendar-list-date">\n                        <span class="calendar-list-day-num">${s}</span>\n                        <span class="calendar-list-day-name">${d[m]}</span>\n                    </div>\n                    <div class="calendar-list-meta">\n                        ${I}\n                        ${p?"":`<span class="calendar-list-capacity ${k}">${y}/${o}</span>`}\n                    </div>\n                </div>\n                ${E}\n            </div>\n        `}s.innerHTML=c}function navigateMonth(e){const t=elements.calendarGrid,n=e>0?"slide-left":"slide-right";t.classList.remove("slide-left","slide-right"),state.currentDate.setMonth(state.currentDate.getMonth()+e),renderCalendar(),joinCurrentRoom(),t.offsetWidth,t.classList.add(n),setTimeout(()=>t.classList.remove(n),200)}function goToToday(){state.currentDate=new Date,renderCalendar(),updateCapacityDisplay(),joinCurrentRoom()}function openBookingModal(e){state.selectedDate=e;const t=new Date(e);document.getElementById("selectedDate").textContent=t.toLocaleDateString("en-ZA",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),document.getElementById("bookingDate").value=e,document.getElementById("bookingId").value="",document.getElementById("bookingNotes").value="",document.getElementById("teamSelect").selectedIndex=0,document.getElementById("modalTitle").textContent="Book Office Space",handleTeamSelect(),updateAvailableSpotsHint(e),renderDayBookings(e),elements.bookingModal.classList.add("active")}function handleTeamSelect(){const e=document.getElementById("teamSelect").value,t=state.teams.find(t=>t.id===e);if(t){const e=t.memberCount||0,n=t.manager||"Not assigned";document.getElementById("peopleCount").value=e;let o=`<strong>${e}</strong> people ¬∑ Manager: <strong>${n}</strong>`;if(state.selectedDate){const t=state.locations.find(e=>e.id===state.currentLocation),n=(t?t.capacity:21)-state.bookings.filter(e=>e.date===state.selectedDate&&e.locationId===state.currentLocation).reduce((e,t)=>e+getBookingPeopleCount(t),0);e>n&&(o+=`<br><span style="color: var(--danger)">‚ö† Exceeds ${n} available spots</span>`)}document.getElementById("teamMemberCount").innerHTML=o}}function closeModal(){elements.bookingModal.classList.remove("active"),state.selectedDate=null}function updateAvailableSpotsHint(e){const t=state.locations.find(e=>e.id===state.currentLocation),n=t?t.capacity:21,o=n-state.bookings.filter(t=>t.date===e&&t.locationId===state.currentLocation).reduce((e,t)=>e+getBookingPeopleCount(t),0);document.getElementById("availableSpots").textContent=`Available: ${o} of ${n}`,document.getElementById("peopleCount").max=o}function renderDayBookings(e){const t=state.bookings.filter(t=>t.date===e&&t.locationId===state.currentLocation),n=document.getElementById("dayBookingsList");if(0===t.length)return void(n.innerHTML='<p style="color: var(--text-muted); font-size: 0.9rem;">No bookings yet</p>');const o=[...t].sort((e,t)=>{const n=state.teams.find(t=>t.id===e.teamId),o=state.teams.find(e=>e.id===t.teamId),a=n?n.name:e.teamName||"",s=o?o.name:t.teamName||"";return a.localeCompare(s)});n.innerHTML=o.map(e=>{const t=state.teams.find(t=>t.id===e.teamId),n=t?t.color:"#6B7280";state.locations.find(t=>t.id===e.locationId);return`\n            <div class="booking-item" style="background: ${n}; border-left: none;">\n                <div class="booking-info">\n                    <span class="booking-team-name" style="color: white;">${t?t.name:e.teamName}</span>\n                    <span class="booking-people" style="color: rgba(255,255,255,0.8);">${t?t.memberCount:e.peopleCount} people</span>\n                </div>\n                <div class="calendar-sync-buttons">\n                    <button class="sync-btn google" onclick="addToGoogleCalendar('${e.id}')" title="Add to Google Calendar">\n                        <svg viewBox="0 0 24 24" fill="currentColor">\n                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>\n                        </svg>\n                    </button>\n                    <button class="sync-btn outlook" onclick="addToOutlookCalendar('${e.id}')" title="Add to Outlook">\n                        <svg viewBox="0 0 24 24" fill="currentColor">\n                            <path d="M7 3h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm5 14a4 4 0 100-8 4 4 0 000 8z"/>\n                        </svg>\n                    </button>\n                    <button class="sync-btn ics" onclick="downloadICS('${e.id}')" title="Download .ics file">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>\n                        </svg>\n                    </button>\n                </div>\n                <div class="booking-actions">\n                    <button onclick="editBooking('${e.id}')" title="Edit">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>\n                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>\n                        </svg>\n                    </button>\n                    <button class="delete" onclick="deleteBooking('${e.id}')" title="Delete">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <polyline points="3 6 5 6 21 6"></polyline>\n                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n                        </svg>\n                    </button>\n                </div>\n            </div>\n        `}).join("")}async function handleBookingSubmit(e){e.preventDefault();const t=document.getElementById("bookingId").value,n=document.getElementById("bookingDate").value,o=document.getElementById("teamSelect").value,a=state.teams.find(e=>e.id===o),s=parseInt(document.getElementById("peopleCount").value),d=document.getElementById("bookingNotes").value;try{if(t){const e=await fetch(`/api/bookings/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({teamId:o,teamName:a?.name,peopleCount:s,notes:d})});if(!e.ok){const t=await e.json();throw new Error(t.error)}showToast("Booking updated successfully","success")}else{const e=await fetch("/api/bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:n,teamId:o,teamName:a?.name,peopleCount:s,locationId:state.currentLocation,notes:d})});if(!e.ok){const t=await e.json();throw new Error(t.error)}showToast("Booking created successfully","success")}await loadData(),renderCalendar(),updateCapacityDisplay(),updateAvailableSpotsHint(n),renderDayBookings(n),document.getElementById("bookingId").value="",document.getElementById("peopleCount").value=1,document.getElementById("bookingNotes").value="",document.getElementById("modalTitle").textContent="Book Office Space"}catch(e){showToast(e.message||"Failed to save booking","error")}}function editBooking(e){const t=state.bookings.find(t=>t.id===e);t&&(document.getElementById("bookingId").value=t.id,document.getElementById("teamSelect").value=t.teamId,document.getElementById("peopleCount").value=t.peopleCount,document.getElementById("bookingNotes").value=t.notes||"",document.getElementById("modalTitle").textContent="Edit Booking",elements.bookingForm.scrollIntoView({behavior:"smooth"}))}async function deleteBooking(e){if(confirm("Are you sure you want to delete this booking?"))try{const t=await fetch(`/api/bookings/${e}`,{method:"DELETE"});if(!t.ok){const e=await t.json();throw new Error(e.error)}showToast("Booking deleted","success"),await loadData(),renderCalendar(),updateCapacityDisplay(),state.selectedDate&&(updateAvailableSpotsHint(state.selectedDate),renderDayBookings(state.selectedDate))}catch(e){showToast(e.message||"Failed to delete booking","error")}}function updateCapacityDisplay(){const e=formatDateStr(new Date),t=state.locations.find(e=>e.id===state.currentLocation),n=t?t.capacity:21,o=state.bookings.filter(t=>t.date===e&&t.locationId===state.currentLocation).reduce((e,t)=>e+getBookingPeopleCount(t),0),a=Math.min(o/n*100,100);elements.capacityLabel.textContent=`${o}/${n}`,elements.capacityFill.style.width=`${a}%`,a>=80?elements.capacityFill.classList.add("warning"):elements.capacityFill.classList.remove("warning")}function renderLocationSelect(){const e=[...state.locations].sort((e,t)=>e.name.localeCompare(t.name));elements.locationSelect.innerHTML=e.map(e=>`<option value="${e.id}" ${e.id===state.currentLocation?"selected":""}>${e.name}</option>`).join("")}function renderTeamSelect(){const e=state.teams.filter(e=>e.locationId===state.currentLocation).sort((e,t)=>e.name.localeCompare(t.name));0===e.length?elements.teamSelect.innerHTML='<option value="">No teams for this location</option>':elements.teamSelect.innerHTML=e.map(e=>`<option value="${e.id}">${e.name} (${e.memberCount||0})</option>`).join("")}function renderTeamLocationSelect(){const e=document.getElementById("teamLocationSelect");if(e){const t=[...state.locations].sort((e,t)=>e.name.localeCompare(t.name));e.innerHTML=t.map(e=>`<option value="${e.id}">${e.name}</option>`).join("")}}function setupSettingsSubmenu(){const e=document.getElementById("settingsToggle"),t=document.getElementById("settingsSubmenu");e&&t&&e.addEventListener("click",()=>{e.classList.toggle("expanded"),t.classList.toggle("open")})}function renderTeamsList(){const e=document.getElementById("teamsList"),t={};state.teams.forEach(e=>{const n=e.locationId||"unassigned";t[n]||(t[n]=[]),t[n].push(e)});let n="";[...state.locations].sort((e,t)=>e.name.localeCompare(t.name)).forEach(e=>{const o=(t[e.id]||[]).sort((e,t)=>e.name.localeCompare(t.name));0!==o.length&&(n+=`<div class="teams-location-group">\n            <h3 class="teams-location-header">${e.name} <span class="team-count">(${o.length} teams)</span></h3>\n            <div class="teams-grid">`,o.forEach(e=>{const t=getAvatarHTML(e.manager,e.managerImage,e.color);n+=`\n                <div class="team-card">\n                    <div class="team-card-color-bar" style="background: ${e.color};"></div>\n                    <div class="team-card-avatar-wrapper">\n                        <div class="team-card-avatar" style="background: ${e.managerImage?"transparent":`linear-gradient(135deg, ${e.color}, ${adjustColor(e.color,-30)})`}; border-color: ${e.color};">\n                            ${t}\n                        </div>\n                    </div>\n                    <div class="team-card-body">\n                        <div class="team-name">${e.name}</div>\n                        <div class="team-manager-name">${e.manager||"No manager assigned"}</div>\n                        <div class="team-meta">\n                            <span class="team-meta-item">\n                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n                                    <circle cx="9" cy="7" r="4"></circle>\n                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n                                </svg>\n                                ${e.memberCount||0} member${1!==e.memberCount?"s":""}\n                            </span>\n                        </div>\n                    </div>\n                    <div class="team-card-actions">\n                        <button class="btn btn-small btn-secondary" data-team-id="${e.id}" onclick="editTeam(this.dataset.teamId)">Edit</button>\n                        <button class="btn btn-small btn-danger" data-team-id="${e.id}" onclick="deleteTeam(this.dataset.teamId)">Delete</button>\n                    </div>\n                </div>\n            `}),n+="</div></div>")}),""===n&&(n='<p style="color: var(--text-muted);">No teams created yet. Click "Add Team" to create one.</p>'),e.innerHTML=n}function getAvatarHTML(e,t,n){return t?`<img src="${t}" alt="${e||"Manager"}" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='${getInitials(e)}';">`:getInitials(e)}function getInitials(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length>=2?(t[0][0]+t[t.length-1][0]).toUpperCase():e.substring(0,2).toUpperCase()}function renderLocationsList(){const e=document.getElementById("locationsList"),t=[...state.locations].sort((e,t)=>e.name.localeCompare(t.name));e.innerHTML=t.map(e=>{const t=e.address&&e.address.trim(),n=t?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.address)}`:"#";return`\n            <div class="location-card">\n                ${t?`\n                    <div class="location-map" id="map-${e.id}" data-address="${encodeURIComponent(e.address)}">\n                        <div class="map-loading">\n                            <svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>\n                            </svg>\n                            Loading map...\n                        </div>\n                        <a href="${n}" target="_blank" class="map-overlay-link" title="Open in Google Maps">\n                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n                                <polyline points="15 3 21 3 21 9"></polyline>\n                                <line x1="10" y1="14" x2="21" y2="3"></line>\n                            </svg>\n                        </a>\n                    </div>\n                `:'\n                    <div class="location-map location-map-empty">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>\n                            <circle cx="12" cy="10" r="3"></circle>\n                        </svg>\n                        <span>No address set</span>\n                    </div>\n                '}\n                <div class="location-card-body">\n                    <div class="location-name">${e.name}</div>\n                    ${t?`<div class="location-address">${e.address}</div>`:""}\n                    <div class="location-meta">\n                        <span class="location-meta-item">\n                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n                                <circle cx="9" cy="7" r="4"></circle>\n                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n                            </svg>\n                            ${e.capacity} capacity\n                        </span>\n                        <span class="location-meta-item">\n                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>\n                                <line x1="3" y1="9" x2="21" y2="9"></line>\n                                <line x1="3" y1="15" x2="21" y2="15"></line>\n                            </svg>\n                            ${e.floors||1} floor${(e.floors||1)>1?"s":""}\n                        </span>\n                    </div>\n                </div>\n                <div class="location-card-actions">\n                    <button class="btn btn-small btn-secondary" data-loc-id="${e.id}" onclick="editLocation(this.dataset.locId)">Edit</button>\n                    <button class="btn btn-small btn-danger" data-loc-id="${e.id}" onclick="deleteLocation(this.dataset.locId)">Delete</button>\n                </div>\n            </div>\n        `}).join(""),initializeLocationMaps()}const locationMaps=new Map;async function initializeLocationMaps(){const e=document.querySelectorAll(".location-map[data-address]");if(0===e.length)return;const t=document.getElementById("settingsView");if(t?.classList.contains("active"))for(const t of e){const e=decodeURIComponent(t.dataset.address),n=t.id;if(!t.querySelector(".leaflet-container")&&!t.querySelector(".location-map-empty")&&(0!==t.offsetWidth&&0!==t.offsetHeight))try{const o=new AbortController,a=setTimeout(()=>o.abort(),5e3),s=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&limit=1`,{signal:o.signal});clearTimeout(a);const d=await s.json();if(d&&d.length>0){const o=parseFloat(d[0].lat),a=parseFloat(d[0].lon);t.innerHTML=`\n                    <div id="${n}-leaflet" style="width: 100%; height: 100%;"></div>\n                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e)}" target="_blank" class="map-overlay-link" title="Open in Google Maps">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n                            <polyline points="15 3 21 3 21 9"></polyline>\n                            <line x1="10" y1="14" x2="21" y2="3"></line>\n                        </svg>\n                    </a>\n                `,await new Promise(e=>setTimeout(e,50));const s=document.getElementById(`${n}-leaflet`);if(!s)continue;if(locationMaps.has(n)){try{locationMaps.get(n).remove()}catch(e){}locationMaps.delete(n)}const l=L.map(s,{zoomControl:!1,attributionControl:!1,dragging:!1,scrollWheelZoom:!1,doubleClickZoom:!1,touchZoom:!1}).setView([o,a],16);L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19,attribution:""}).addTo(l);const i=`data:image/svg+xml,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 32" width="32" height="42"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20c0-6.6-5.4-12-12-12z" fill="%23d95c02"/><circle cx="12" cy="12" r="5" fill="white"/></svg>')}`,c=L.icon({iconUrl:i,iconSize:[32,42],iconAnchor:[16,42],popupAnchor:[0,-42]});L.marker([o,a],{icon:c}).addTo(l),setTimeout(()=>l.invalidateSize(),100),locationMaps.set(n,l)}else t.innerHTML='\n                    <div class="location-map-empty">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>\n                            <circle cx="12" cy="10" r="3"></circle>\n                        </svg>\n                        <span>Address not found</span>\n                    </div>\n                '}catch(n){console.error("Failed to load map for:",e,n),t.innerHTML='\n                <div class="location-map-empty">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>\n                        <circle cx="12" cy="10" r="3"></circle>\n                    </svg>\n                    <span>Map unavailable</span>\n                </div>\n            '}}}async function handleTeamSubmit(e){e.preventDefault();const t=document.getElementById("editTeamId").value,n=document.getElementById("teamLocationSelect").value,o=document.getElementById("teamName").value,a=document.getElementById("teamManager").value,s=document.getElementById("teamManagerImage").value,d=document.getElementById("teamColor").value,l=parseInt(document.getElementById("teamMemberCountInput").value);try{let e;if(e=t?await fetch(`/api/teams/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o,manager:a,managerImage:s,color:d,memberCount:l,locationId:n})}):await fetch("/api/teams",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o,manager:a,managerImage:s,color:d,memberCount:l,locationId:n})}),!e.ok){const t=await e.json();throw new Error(t.error)}showToast(t?"Team updated successfully":"Team created successfully","success"),closeTeamModal(),await loadData(),renderTeamsList(),renderTeamSelect(),renderCalendar(),updateCapacityDisplay()}catch(e){showToast(e.message||"Failed to save team","error")}}function editTeam(e){const t=state.teams.find(t=>t.id===e);t?(renderTeamLocationSelect(),document.getElementById("editTeamId").value=t.id,document.getElementById("teamLocationSelect").value=t.locationId||state.locations[0]?.id,document.getElementById("teamName").value=t.name,document.getElementById("teamManager").value=t.manager||"",document.getElementById("teamManagerImage").value=t.managerImage||"",document.getElementById("teamMemberCountInput").value=t.memberCount||0,document.getElementById("teamColor").value=t.color,document.getElementById("teamFormSubmitBtn").textContent="Save Changes",document.querySelector("#teamModal .modal-header h2").textContent="Edit Team",elements.teamModal.classList.add("active")):showToast("Team not found. Please refresh the page.","error")}async function handleLocationSubmit(e){e.preventDefault();const t=document.getElementById("editLocationId").value,n=document.getElementById("locationName").value,o=document.getElementById("locationAddress").value,a=parseInt(document.getElementById("locationCapacity").value),s=parseInt(document.getElementById("locationFloors").value)||1;try{let e;if(e=t?await fetch(`/api/locations/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,address:o,capacity:a,floors:s})}):await fetch("/api/locations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,address:o,capacity:a,floors:s})}),!e.ok){const t=await e.json();throw new Error(t.error)}showToast(t?"Location updated successfully":"Location created successfully","success"),closeLocationModal(),await loadData(),renderLocationsList(),renderLocationSelect(),renderCalendar(),updateCapacityDisplay()}catch(e){showToast(e.message||"Failed to save location","error")}}function editLocation(e){const t=state.locations.find(t=>t.id===e);t&&(document.getElementById("editLocationId").value=t.id,document.getElementById("locationName").value=t.name,document.getElementById("locationAddress").value=t.address||"",document.getElementById("locationCapacity").value=t.capacity,document.getElementById("locationFloors").value=t.floors||1,document.getElementById("locationFormSubmitBtn").textContent="Save Changes",document.getElementById("locationModalTitle").textContent="Edit Location",elements.locationModal.classList.add("active"))}async function deleteTeam(e){if(confirm("Are you sure you want to delete this team?"))try{await fetch(`/api/teams/${e}`,{method:"DELETE"}),showToast("Team deleted","success"),await loadData(),renderTeamsList(),renderTeamSelect(),renderCalendar(),updateCapacityDisplay()}catch(e){showToast("Failed to delete team","error")}}async function deleteLocation(e){if(confirm("Delete this location? All bookings for this location will also be deleted."))try{await fetch(`/api/locations/${e}`,{method:"DELETE"}),showToast("Location deleted","success"),await loadData(),state.locations.length>0&&!state.locations.find(e=>e.id===state.currentLocation)&&(state.currentLocation=state.locations[0].id),renderLocationsList(),renderLocationSelect(),renderCalendar()}catch(e){showToast("Failed to delete location","error")}}function closeTeamModal(){elements.teamModal.classList.remove("active"),elements.teamForm.reset(),document.getElementById("editTeamId").value="",document.getElementById("teamManager").value="",document.getElementById("teamManagerImage").value="",document.getElementById("teamFormSubmitBtn").textContent="Add Team",document.querySelector("#teamModal .modal-header h2").textContent="Add Team"}let tooltipTimeout=null;function showTeamTooltip(e,t){const n=state.teams.find(e=>e.id===t);if(!n)return;const o=document.getElementById("teamTooltip"),a=document.getElementById("tooltipAvatar"),s=document.getElementById("tooltipTeamName"),d=document.getElementById("tooltipManager"),l=document.getElementById("tooltipMembers");s.textContent=n.name,d.textContent=n.manager?`SM: ${n.manager}`:"No manager assigned",l.textContent=`${n.memberCount||0} team members`,n.managerImage?(a.innerHTML=`<img src="${n.managerImage}" alt="${n.manager||"Manager"}" loading="lazy" onerror="this.parentElement.innerHTML='${getInitials(n.manager)}';">`,a.style.background="transparent"):(a.innerHTML=getInitials(n.manager),a.style.background=`linear-gradient(135deg, ${n.color}, ${adjustColor(n.color,-30)})`);const i=e.target.getBoundingClientRect();o.getBoundingClientRect();let c=i.left+i.width/2,r=i.bottom+8;c+120>window.innerWidth&&(c=window.innerWidth-130),c<10&&(c=10),r+100>window.innerHeight&&(r=i.top-100),o.style.left=`${c}px`,o.style.top=`${r}px`,clearTimeout(tooltipTimeout),tooltipTimeout=setTimeout(()=>{o.classList.add("visible")},100)}function hideTeamTooltip(){clearTimeout(tooltipTimeout);document.getElementById("teamTooltip").classList.remove("visible")}function adjustColor(e,t){const n=e.replace("#",""),o=Math.max(0,Math.min(255,parseInt(n.substring(0,2),16)+t)),a=Math.max(0,Math.min(255,parseInt(n.substring(2,4),16)+t)),s=Math.max(0,Math.min(255,parseInt(n.substring(4,6),16)+t));return`#${o.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`}function closeLocationModal(){elements.locationModal.classList.remove("active"),elements.locationForm.reset(),document.getElementById("editLocationId").value="",document.getElementById("locationAddress").value="",document.getElementById("locationFormSubmitBtn").textContent="Add Location",document.getElementById("locationModalTitle").textContent="Add Location"}function renderHolidayYearSelect(){const e=document.getElementById("holidayYear"),t=(new Date).getFullYear();e.innerHTML="";for(let n=t;n<=t+3;n++){const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)}}function renderHolidaysList(){const e=document.getElementById("holidaysList");if(0===state.publicHolidays.length)return void(e.innerHTML='<div class="no-holidays">No holidays configured. Click "Fetch SA Holidays" to load public holidays.</div>');const t={};state.publicHolidays.forEach(e=>{const n=e.date.substring(0,4);t[n]||(t[n]=[]),t[n].push(e)});let n="";Object.keys(t).sort().reverse().forEach(e=>{const o=t[e].sort((e,t)=>e.date.localeCompare(t.date));n+=`<div class="holidays-year-group"><h3>${e}</h3><div class="holidays-list">`,o.forEach(e=>{const t=new Date(e.date).toLocaleDateString("en-ZA",{weekday:"short",day:"numeric",month:"short"});n+=`\n                <div class="holiday-item">\n                    <div class="holiday-info">\n                        <span class="holiday-date">${t}</span>\n                        <span class="holiday-name">${e.name}</span>\n                    </div>\n                    <button class="delete-btn" onclick="deleteHoliday('${e.date}')" title="Delete">\n                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <polyline points="3 6 5 6 21 6"></polyline>\n                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n                        </svg>\n                    </button>\n                </div>\n            `}),n+="</div></div>"}),e.innerHTML=n}async function fetchHolidays(){const e=document.getElementById("holidayYear").value,t=document.getElementById("fetchHolidaysBtn");t.disabled=!0,t.innerHTML='\n        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">\n            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>\n        </svg>\n        Fetching...\n    ';try{const t=await fetch(`/api/holidays/fetch/${e}?country=ZA`);if(!t.ok)throw new Error("Failed to fetch holidays");const n=await t.json();if(!(await fetch("/api/holidays",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({holidays:n})})).ok)throw new Error("Failed to save holidays");showToast(`Loaded ${n.length} holidays for ${e}`,"success"),await loadData(),renderCalendar()}catch(e){console.error("Error fetching holidays:",e),showToast("Failed to fetch holidays. Check your internet connection.","error")}finally{t.disabled=!1,t.innerHTML='\n            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9"></path>\n            </svg>\n            Fetch SA Holidays\n        '}}async function deleteHoliday(e){if(confirm("Remove this holiday?"))try{await fetch(`/api/holidays/${e}`,{method:"DELETE"}),showToast("Holiday removed","success"),await loadData(),renderCalendar()}catch(e){showToast("Failed to delete holiday","error")}}function switchView(e){document.querySelectorAll(".nav-item").forEach(t=>{t.classList.toggle("active",t.dataset.view===e)}),document.querySelectorAll(".view").forEach(t=>{t.classList.toggle("active",t.id===`${e}View`)}),"desks"===e&&initDesksView(),"settings"===e&&setTimeout(()=>{renderLocationsList()},200)}function getBookingPeopleCount(e){const t=state.teams.find(t=>t.id===e.teamId);return t?t.memberCount:e.peopleCount}function formatDateStr(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function showToast(e,t="success"){const n=document.createElement("div");n.className=`toast ${t}`,n.innerHTML=`\n        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">\n            ${"success"===t?'<polyline points="20 6 9 17 4 12"></polyline>':'<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'}\n        </svg>\n        <span>${e}</span>\n    `,elements.toastContainer.appendChild(n),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateX(100px)",setTimeout(()=>n.remove(),300)},3e3)}let draggedBookingId=null;function handleDragStart(e,t){draggedBookingId=t,e.target.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t),hideTeamTooltip()}function handleDragEnd(e){e.target.classList.remove("dragging"),draggedBookingId=null,document.querySelectorAll(".calendar-day.drag-over").forEach(e=>{e.classList.remove("drag-over")})}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move";const t=e.target.closest(".calendar-day");!t||t.classList.contains("weekend")||t.classList.contains("holiday")||t.classList.contains("other-month")||t.classList.add("drag-over")}function handleDragLeave(e){const t=e.target.closest(".calendar-day");t&&t.classList.remove("drag-over")}async function handleDrop(e,t){e.preventDefault();const n=e.target.closest(".calendar-day");if(n&&n.classList.remove("drag-over"),!draggedBookingId)return;const o=state.bookings.find(e=>e.id===draggedBookingId);if(!o)return;if(o.date===t)return;const a=o.date,s=draggedBookingId,d=o.teamName;o.date=t,renderCalendar();const l=document.querySelector(`.booking-chip[data-booking-id="${s}"]`);l&&l.classList.add("updating");try{const e=await fetch(`/api/bookings/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:t})});if(!e.ok){const t=await e.json();throw new Error(t.error)}showToast(`Moved ${d} to ${formatDisplayDate(t)}`,"success"),await loadData(),renderCalendar()}catch(e){o.date=a,renderCalendar(),showToast(e.message||"Failed to move booking","error")}draggedBookingId=null}function formatDisplayDate(e){return new Date(e).toLocaleDateString("en-ZA",{weekday:"short",day:"numeric",month:"short"})}function addToGoogleCalendar(e){const t=state.bookings.find(t=>t.id===e);if(!t)return;const n=state.locations.find(e=>e.id===t.locationId),o=state.teams.find(e=>e.id===t.teamId),a=t.date.replace(/-/g,""),s=`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`${t.teamName} - Office Booking`)}&dates=${a}/${a}&details=${encodeURIComponent(`Team: ${t.teamName}\nPeople: ${t.peopleCount}\nManager: ${o?.manager||"N/A"}\n${t.notes||""}`)}&location=${encodeURIComponent(n?.name||"Office")}`;window.open(s,"_blank")}function addToOutlookCalendar(e){const t=state.bookings.find(t=>t.id===e);if(!t)return;const n=state.locations.find(e=>e.id===t.locationId),o=state.teams.find(e=>e.id===t.teamId),a=`https://outlook.office.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(`${t.teamName} - Office Booking`)}&body=${encodeURIComponent(`Team: ${t.teamName}\nPeople: ${t.peopleCount}\nManager: ${o?.manager||"N/A"}\n${t.notes||""}`)}&location=${encodeURIComponent(n?.name||"Office")}&startdt=${t.date}&allday=true`;window.open(a,"_blank")}function downloadICS(e){window.location.href=`/api/bookings/${e}/ics`}let deskState={desks:[],deskBookings:[],floorElements:[],selectedDate:formatDateStr(new Date),editMode:!1,currentFloor:"1",selectedElement:null,activeTool:null,draggedDesk:null};async function loadDesks(){try{const e=state.currentLocation,t=deskState.currentFloor,n=await fetch(`/api/desks?locationId=${e}`),o=await n.json();deskState.desks=o.filter(e=>(e.floor||"1")===t);const a=deskState.selectedDate,s=await fetch(`/api/desk-bookings?locationId=${e}&date=${a}`);deskState.deskBookings=await s.json();const d=await fetch(`/api/floor-elements?locationId=${e}&floor=${t}`);deskState.floorElements=await d.json(),renderFloorMap()}catch(e){console.error("Failed to load desks:",e)}}let resizeTimeout,desksViewInitialized=!1;function initDesksView(){const e=document.getElementById("deskDateSelect"),t=document.getElementById("deskForm"),n=document.getElementById("deskBookingForm"),o=document.getElementById("toggleEditMode"),a=document.getElementById("floorSelect"),s=document.getElementById("deskType");e.value=deskState.selectedDate,updateFloorSelector(),desksViewInitialized||(e.addEventListener("change",e=>{deskState.selectedDate=e.target.value,loadDesks()}),a.addEventListener("change",e=>{deskState.currentFloor=e.target.value,loadDesks()}),t.addEventListener("submit",handleDeskSubmit),n.addEventListener("submit",handleDeskBookingSubmit),o.addEventListener("click",toggleEditMode),s.addEventListener("change",e=>{document.getElementById("assignedTeamGroup").style.display="team_seat"===e.target.value?"block":"none"}),document.querySelectorAll(".toolbar-btn[data-tool]").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tool;"desk"===t?openDeskModal():"room"===t?openRoomModal():"wall"===t?addWallElement():"label"===t&&openLabelModal()})}),document.getElementById("deleteSelectedBtn")?.addEventListener("click",deleteSelectedElement),document.getElementById("applyDeskBtn")?.addEventListener("click",()=>{deskState.selectedElement&&openDeskBookingModal(deskState.selectedElement.id)}),document.getElementById("roomForm")?.addEventListener("submit",handleRoomSubmit),document.getElementById("labelForm")?.addEventListener("submit",handleLabelSubmit),document.getElementById("wallForm")?.addEventListener("submit",handleWallSubmit),desksViewInitialized=!0);const d=document.getElementById("assignedTeamId");if(d){const e=[...state.teams].sort((e,t)=>e.name.localeCompare(t.name));d.innerHTML=e.map(e=>`<option value="${e.id}">${e.name}</option>`).join("")}loadDesks()}function updateFloorSelector(){const e=document.getElementById("floorSelect"),t=state.locations.find(e=>e.id===state.currentLocation),n=t?.floors||1;e.innerHTML="";for(let t=1;t<=n;t++){const n=1===t?"st":2===t?"nd":3===t?"rd":"th";e.innerHTML+=`<option value="${t}">${t}${n} Floor</option>`}parseInt(deskState.currentFloor)>n&&(deskState.currentFloor="1"),e.value=deskState.currentFloor,e.style.display=n>1?"block":"none"}function toggleEditMode(){deskState.editMode=!deskState.editMode;const e=document.getElementById("editModePanel"),t=document.getElementById("toggleEditMode"),n=document.getElementById("floorMap");deskState.editMode?(e.style.display="block",t.innerHTML='\n            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="20 6 9 17 4 12"></polyline>\n            </svg>\n            Done Editing\n        ',t.classList.add("btn-primary"),t.classList.remove("btn-secondary"),n.classList.add("edit-mode")):(e.style.display="none",t.innerHTML='\n            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>\n                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>\n            </svg>\n            Edit Layout\n        ',t.classList.remove("btn-primary"),t.classList.add("btn-secondary"),n.classList.remove("edit-mode")),renderFloorMap()}function renderFloorMap(){const e=document.getElementById("floorMap"),t=localStorage.getItem("employeeName")||"";let n="";if(n+=deskState.floorElements.map(e=>{const t=deskState.selectedElement?.id===e.id;if("room"===e.type){const n=`left: ${e.x||0}px; top: ${e.y||0}px; width: ${e.width||150}px; height: ${e.height||120}px; ${e.color?`border-color: ${e.color}50; background: ${e.color}08;`:""}`,o=deskState.editMode?'\n                <div class="resize-handle nw" data-handle="nw"></div>\n                <div class="resize-handle ne" data-handle="ne"></div>\n                <div class="resize-handle sw" data-handle="sw"></div>\n                <div class="resize-handle se" data-handle="se"></div>\n                <div class="resize-handle n" data-handle="n"></div>\n                <div class="resize-handle s" data-handle="s"></div>\n                <div class="resize-handle e" data-handle="e"></div>\n                <div class="resize-handle w" data-handle="w"></div>\n            ':"";return`\n                <div class="floor-room ${deskState.editMode?"edit-mode":""} ${t?"selected":""}" \n                     id="element-${e.id}"\n                     style="${n}"\n                     data-element-id="${e.id}"\n                     data-element-type="room">\n                    ${e.label?`<span class="room-label">${e.label}</span>`:""}\n                    ${o}\n                </div>\n            `}if("wall"===e.type){const n=e.rotation||0,o=e.width||100,a=e.height||6;let s=`left: ${e.x||0}px; top: ${e.y||0}px; width: ${o}px; height: ${a}px;`;n&&(s+=` transform: rotate(${n}deg); transform-origin: left center;`);const d=deskState.editMode?'\n                <div class="resize-handle e" data-handle="e"></div>\n                <div class="resize-handle w" data-handle="w"></div>\n            ':"";return`\n                <div class="floor-wall ${deskState.editMode?"edit-mode":""} ${t?"selected":""}" \n                     id="element-${e.id}"\n                     style="${s}"\n                     data-element-id="${e.id}"\n                     data-element-type="wall"\n                     onclick="selectElement('${e.id}', 'wall')">\n                    ${d}\n                </div>\n            `}if("label"===e.type){const n=`left: ${e.x||0}px; top: ${e.y||0}px;`;return`\n                <div class="floor-label ${deskState.editMode?"edit-mode":""} ${t?"selected":""}" \n                     id="element-${e.id}"\n                     style="${n}"\n                     data-element-id="${e.id}"\n                     data-element-type="label"\n                     onclick="selectElement('${e.id}', 'label')">\n                    ${e.label||""}\n                </div>\n            `}return""}).join(""),0===deskState.desks.length&&0===deskState.floorElements.length)return n='\n            <div class="no-desks-map">\n                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>\n                    <path d="M16 7V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v3"></path>\n                </svg>\n                <p>No floor plan configured</p>\n                <button class="btn btn-primary" onclick="toggleEditMode();">Start Editing</button>\n            </div>\n        ',void(e.innerHTML=n);n+=deskState.desks.map(e=>{const n=deskState.deskBookings.find(t=>t.deskId===e.id),o=!!n,a=n&&n.employeeName.toLowerCase()===t.toLowerCase(),s="unavailable"===e.deskType,d="team_seat"===e.deskType;"hotseat"===e.deskType||e.deskType;let l="",i="",c="";if(s)l="unavailable";else if(o){if(l=a?"my-booking":"booked",n.teamId){const e=state.teams.find(e=>e.id===n.teamId);e&&e.color&&(i=e.color,c=e.name)}}else if(d){l="team-seat";const t=state.teams.find(t=>t.id===e.assignedTeamId);t&&(i=t.color,c=t.name)}else l="hotseat";const r=deskState.selectedElement?.id===e.id,m=e.chairPositions||["bottom"];let u=`left: ${e.x||0}px; top: ${e.y||0}px; width: ${e.width||60}px; height: ${e.height||40}px;`;i&&o&&(u+=` border-color: ${i}; --team-color: ${i};`);const g=m.map(e=>`<div class="desk-chair ${e}"></div>`).join("");return`\n            <div class="floor-desk ${l} ${r?"selected":""} ${deskState.editMode?"draggable":""}" \n                 id="desk-${e.id}"\n                 style="${u}"\n                 data-desk-id="${e.id}"\n                 onclick="handleDeskClick('${e.id}')"\n                 title="${o?`${n.employeeName}${c?" ("+c+")":""} - Full Day`:s?"Unavailable":d?`Team: ${c}`:"Click to book"}">\n                ${g}\n                <div class="desk-label">${e.name}</div>\n                ${o?`<div class="desk-occupant">${n.employeeName}</div>`:""}\n                ${deskState.editMode?`\n                    <div class="desk-edit-controls">\n                        <button onclick="event.stopPropagation(); deleteDesk('${e.id}')" title="Delete">√ó</button>\n                    </div>\n                `:""}\n            </div>\n        `}).join(""),e.innerHTML=n,deskState.editMode&&(setupDeskDragging(),setupElementDragging()),requestAnimationFrame(()=>scaleFloorMap())}function scaleFloorMap(){const e=document.getElementById("floorMap"),t=document.querySelector(".floor-map-container");if(!e||!t)return;e.style.transition="none";const n=t.getBoundingClientRect(),o=n.width-20,a=n.height-20;if(o<=0||a<=0)return void requestAnimationFrame(()=>scaleFloorMap());const s=o/1200,d=a/800,l=Math.min(s,d,1);if(window.matchMedia("(max-width: 768px)").matches){e.style.transformOrigin="top left";const t=1200*l,o=800*l,a=Math.max(0,(n.width-t)/2),s=Math.max(0,(n.height-o)/2);e.style.transform=`translate(${a}px, ${s}px) scale(${l})`}else e.style.transformOrigin="center center",e.style.transform=`scale(${l})`;requestAnimationFrame(()=>{e.style.transition=""})}function handleDeskClick(e){const t=deskState.desks.find(t=>t.id===e);if(!t)return;if(deskState.editMode)return void editDesk(e);const n=deskState.deskBookings.find(t=>t.deskId===e);if(n)return void showBookingInfoPopup(t,n);if("unavailable"===t.deskType)return void showToast("This desk is unavailable","error");if("team_seat"===t.deskType){if(localStorage.getItem("employeeTeamId")!==t.assignedTeamId){const e=state.teams.find(e=>e.id===t.assignedTeamId);showToast(`This desk is reserved for ${e?.name||"a specific team"}`,"warning")}}localStorage.getItem("employeeName")?quickBookDesk(t):showQuickBookModal(t)}function showBookingInfoPopup(e,t){state.locations.find(t=>t.id===e.locationId);const n=t.teamId?state.teams.find(e=>e.id===t.teamId):null,o=localStorage.getItem("employeeName"),a=o&&t.employeeName.toLowerCase()===o.toLowerCase(),s=document.createElement("div");s.className="desk-info-popup",s.innerHTML=`\n        <div class="desk-info-popup-content">\n            <button class="popup-close" onclick="this.closest('.desk-info-popup').remove()">√ó</button>\n            <div class="popup-header">\n                <h3>${e.name}</h3>\n                <span class="popup-status booked">Booked</span>\n            </div>\n            <div class="popup-details">\n                <div class="popup-row">\n                    <span class="popup-label">Booked by</span>\n                    <span class="popup-value">${t.employeeName}</span>\n                </div>\n                ${n?`\n                <div class="popup-row">\n                    <span class="popup-label">Team</span>\n                    <span class="popup-value" style="color: ${n.color}">${n.name}</span>\n                </div>\n                `:""}\n                <div class="popup-row">\n                    <span class="popup-label">Date</span>\n                    <span class="popup-value">${new Date(deskState.selectedDate).toLocaleDateString("en-ZA",{weekday:"short",day:"numeric",month:"short"})}</span>\n                </div>\n                ${t.checkedIn?'\n                <div class="popup-row">\n                    <span class="popup-label">Status</span>\n                    <span class="popup-value checked-in">‚úì Checked In</span>\n                </div>\n                ':""}\n            </div>\n            ${a?`\n            <div class="popup-actions">\n                <button class="btn btn-danger btn-small" onclick="cancelBookingFromPopup('${t.id}', '${e.id}')">Cancel Booking</button>\n            </div>\n            `:""}\n        </div>\n    `,document.querySelectorAll(".desk-info-popup").forEach(e=>e.remove()),document.body.appendChild(s),s.addEventListener("click",e=>{e.target===s&&s.remove()});const d=e=>{"Escape"===e.key&&(s.remove(),document.removeEventListener("keydown",d))};document.addEventListener("keydown",d)}async function quickBookDesk(e){const t=localStorage.getItem("employeeName"),n=localStorage.getItem("employeeEmail")||"",o=localStorage.getItem("employeeTeamId")||null,a=document.getElementById(`desk-${e.id}`);a&&a.classList.add("booking");try{const a=await fetch("/api/desk-bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deskId:e.id,date:deskState.selectedDate,employeeName:t,employeeEmail:n,teamId:o})});if(!a.ok){const e=await a.json();throw new Error(e.error)}showToast(`${e.name} booked for the day!`,"success");const s=await fetch(`/api/desk-bookings?locationId=${state.currentLocation}&date=${deskState.selectedDate}`);deskState.deskBookings=await s.json(),renderFloorMap()}catch(e){showToast(e.message||"Failed to book desk","error"),a&&a.classList.remove("booking")}}function showQuickBookModal(e){const t=localStorage.getItem("employeeTeamId"),n=document.createElement("div");n.className="desk-info-popup",n.innerHTML=`\n        <div class="desk-info-popup-content quick-book">\n            <button class="popup-close" onclick="this.closest('.desk-info-popup').remove()">√ó</button>\n            <div class="popup-header">\n                <h3>Book ${e.name}</h3>\n            </div>\n            <p class="popup-hint">Enter your name to book this desk. Your info will be saved for quick booking next time.</p>\n            <form id="quickBookForm" class="quick-book-form">\n                <input type="hidden" id="quickBookDeskId" value="${e.id}">\n                <div class="form-group">\n                    <input type="text" id="quickBookName" required placeholder="Your name" autofocus>\n                </div>\n                <div class="form-group">\n                    <select id="quickBookTeam">\n                        <option value="">Team (optional)</option>\n                        ${state.teams.map(e=>`<option value="${e.id}" ${e.id===t?"selected":""} style="color: ${e.color}">${e.name}</option>`).join("")}\n                    </select>\n                </div>\n                <button type="submit" class="btn btn-primary btn-full">Book Desk</button>\n            </form>\n        </div>\n    `,document.querySelectorAll(".desk-info-popup").forEach(e=>e.remove()),document.body.appendChild(n),setTimeout(()=>document.getElementById("quickBookName")?.focus(),100),document.getElementById("quickBookForm").addEventListener("submit",async t=>{t.preventDefault();const o=document.getElementById("quickBookName").value.trim(),a=document.getElementById("quickBookTeam").value||null;o&&(localStorage.setItem("employeeName",o),a&&localStorage.setItem("employeeTeamId",a),n.remove(),await quickBookDesk(e))}),n.addEventListener("click",e=>{e.target===n&&n.remove()});const o=e=>{"Escape"===e.key&&(n.remove(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)}async function cancelBookingFromPopup(e,t){if(confirm("Cancel this booking?"))try{await fetch(`/api/desk-bookings/${e}`,{method:"DELETE"}),showToast("Booking cancelled","success"),document.querySelectorAll(".desk-info-popup").forEach(e=>e.remove());const t=await fetch(`/api/desk-bookings?locationId=${state.currentLocation}&date=${deskState.selectedDate}`);deskState.deskBookings=await t.json(),renderFloorMap()}catch(e){showToast("Failed to cancel booking","error")}}function selectElement(e,t){if(!deskState.editMode)return;const n=deskState.floorElements.find(t=>t.id===e);if(!n)return;deskState.selectedElement={...n,elementType:t},document.getElementById("selectedElementInfo").textContent=`${t}: ${n.label||e}`,document.getElementById("deleteSelectedBtn").style.display="flex",document.querySelectorAll(".floor-room, .floor-wall, .floor-label").forEach(e=>{e.classList.remove("selected")});const o=document.getElementById(`element-${e}`);o&&o.classList.add("selected")}function handleFloorElementClick(e){if(!deskState.editMode)return;if(dragState.active)return;const t=e.target.closest(".floor-room, .floor-wall, .floor-label");if(!t)return;const n=t.dataset.elementId,o=t.dataset.elementType;n&&o&&selectElement(n,o)}async function deleteSelectedElement(){if(!deskState.selectedElement)return;const e=deskState.selectedElement;if(e.elementType){if(!confirm(`Delete this ${e.elementType}?`))return;try{await fetch(`/api/floor-elements/${e.id}`,{method:"DELETE"}),showToast(`${e.elementType} deleted`,"success"),loadDesks()}catch(e){showToast("Failed to delete","error")}}else deleteDesk(e.id);deskState.selectedElement=null,document.getElementById("selectedElementInfo").textContent="None",document.getElementById("deleteSelectedBtn").style.display="none"}window.addEventListener("resize",()=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{document.getElementById("desksView")?.classList.contains("active")&&scaleFloorMap()},100)});let dragState={active:!1,didMove:!1,type:null,elementId:null,elementType:null,startX:0,startY:0,initialX:0,initialY:0,initialWidth:0,initialHeight:0,resizeHandle:null};function setupElementDragging(){const e=document.getElementById("floorMap");e.dataset.listenersAdded||(e.addEventListener("mousedown",handleElementMouseDown),e.addEventListener("click",handleFloorElementClick),document.addEventListener("mousemove",handleElementMouseMove),document.addEventListener("mouseup",handleElementMouseUp),e.dataset.listenersAdded="true")}function handleElementMouseDown(e){if(!deskState.editMode)return;const t=e.target,n=document.getElementById("floorMap"),o=n.getBoundingClientRect();if(t.classList.contains("resize-handle")){const n=t.closest(".floor-room, .floor-wall");if(!n)return;n.getBoundingClientRect();return dragState={active:!0,didMove:!1,type:"resize",elementId:n.dataset.elementId,elementType:n.dataset.elementType,startX:e.clientX,startY:e.clientY,initialX:parseInt(n.style.left)||0,initialY:parseInt(n.style.top)||0,initialWidth:parseInt(n.style.width)||100,initialHeight:parseInt(n.style.height)||100,resizeHandle:t.dataset.handle},n.classList.add("resizing"),e.preventDefault(),void e.stopPropagation()}const a=t.closest(".floor-room.edit-mode, .floor-wall.edit-mode, .floor-label.edit-mode");if(!a)return;const s=a.getBoundingClientRect();dragState={active:!0,didMove:!1,type:"move",elementId:a.dataset.elementId,elementType:a.dataset.elementType,startX:e.clientX,startY:e.clientY,initialX:s.left-o.left+n.scrollLeft,initialY:s.top-o.top+n.scrollTop,initialWidth:parseInt(a.style.width)||100,initialHeight:parseInt(a.style.height)||100,resizeHandle:null},a.classList.add("dragging"),e.preventDefault(),e.stopPropagation()}function handleElementMouseMove(e){if(!dragState.active)return;const t=document.getElementById(`element-${dragState.elementId}`);if(!t)return;const n=e.clientX-dragState.startX,o=e.clientY-dragState.startY;if((Math.abs(n)>3||Math.abs(o)>3)&&(dragState.didMove=!0),"move"===dragState.type){let e=dragState.initialX+n,a=dragState.initialY+o;e=10*Math.round(e/10),a=10*Math.round(a/10),e=Math.max(0,e),a=Math.max(0,a),t.style.left=`${e}px`,t.style.top=`${a}px`}else if("resize"===dragState.type){let e=dragState.initialWidth,a=dragState.initialHeight,s=dragState.initialX,d=dragState.initialY;const l=dragState.resizeHandle,i=30,c=4;if(l.includes("e")&&(e=Math.max(i,dragState.initialWidth+n)),l.includes("w")){const t=dragState.initialWidth-n;e=Math.max(i,t);s=dragState.initialX+dragState.initialWidth-e}if(l.includes("s")&&(a=Math.max(c,dragState.initialHeight+o)),l.includes("n")){const e=dragState.initialHeight-o;a=Math.max(c,e);d=dragState.initialY+dragState.initialHeight-a}e=10*Math.round(e/10),a=10*Math.round(a/10),s=10*Math.round(s/10),d=10*Math.round(d/10),t.style.width=`${e}px`,t.style.height=`${a}px`,t.style.left=`${s}px`,t.style.top=`${d}px`}}async function handleElementMouseUp(e){if(!dragState.active)return;const t=document.getElementById(`element-${dragState.elementId}`);if(t&&(t.classList.remove("dragging","resizing"),dragState.didMove)){const e=parseInt(t.style.left)||0,n=parseInt(t.style.top)||0,o=parseInt(t.style.width)||100,a=parseInt(t.style.height)||100;try{if((await fetch(`/api/floor-elements/${dragState.elementId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:e,y:n,width:o,height:a})})).ok){const t=deskState.floorElements.findIndex(e=>e.id===dragState.elementId);-1!==t&&(deskState.floorElements[t].x=e,deskState.floorElements[t].y=n,deskState.floorElements[t].width=o,deskState.floorElements[t].height=a),console.log("Element position saved:",{x:e,y:n,width:o,height:a})}}catch(e){console.error("Failed to save element position:",e),showToast("Failed to save position","error")}}dragState={active:!1,didMove:!1,type:null,elementId:null,elementType:null,startX:0,startY:0,initialX:0,initialY:0,initialWidth:0,initialHeight:0,resizeHandle:null}}function setupDeskDragging(){const e=document.getElementById("floorMap");e.querySelectorAll(".floor-desk.draggable").forEach(t=>{let n,o,a,s,d=!1;t.addEventListener("mousedown",l=>{if("BUTTON"===l.target.tagName)return;d=!0,t.classList.add("dragging");const i=t.getBoundingClientRect(),c=e.getBoundingClientRect();n=l.clientX,o=l.clientY,a=i.left-c.left,s=i.top-c.top,l.preventDefault()}),document.addEventListener("mousemove",e=>{if(!d)return;const l=e.clientX-n,i=e.clientY-o;let c=a+l,r=s+i;c=10*Math.round(c/10),r=10*Math.round(r/10),c=Math.max(0,c),r=Math.max(0,r),t.style.left=`${c}px`,t.style.top=`${r}px`}),document.addEventListener("mouseup",async()=>{if(!d)return;d=!1,t.classList.remove("dragging");const e=t.dataset.deskId,n=parseInt(t.style.left),o=parseInt(t.style.top);try{await fetch(`/api/desks/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({x:n,y:o})});const t=deskState.desks.find(t=>t.id===e);t&&(t.x=n,t.y=o)}catch(e){console.error("Failed to save desk position:",e)}})})}function renderDesksGrid(){renderFloorMap()}function openDeskModal(e=null){const t=document.getElementById("deskModal"),n=document.getElementById("deskModalTitle"),o=document.getElementById("deskFormSubmitBtn"),a=document.getElementById("deskLocationInput"),s=document.getElementById("deskType"),d=document.getElementById("assignedTeamGroup"),l=document.getElementById("assignedTeamId"),i=[...state.locations].sort((e,t)=>e.name.localeCompare(t.name));a.innerHTML=i.map(e=>`<option value="${e.id}" ${e.id===state.currentLocation?"selected":""}>${e.name}</option>`).join("");const c=[...state.teams].sort((e,t)=>e.name.localeCompare(t.name));if(l.innerHTML=c.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""),e){const t=deskState.desks.find(t=>t.id===e);t&&(document.getElementById("editDeskId").value=t.id,document.getElementById("deskName").value=t.name,document.getElementById("deskFloor").value=t.floor||deskState.currentFloor,document.getElementById("deskZone").value=t.zone||"",document.getElementById("deskWidth").value=t.width||60,document.getElementById("deskHeight").value=t.height||40,s.value=t.deskType||"hotseat",d.style.display="team_seat"===t.deskType?"block":"none",t.assignedTeamId&&(l.value=t.assignedTeamId),a.value=t.locationId,document.querySelectorAll('input[name="chairPos"]').forEach(e=>{e.checked=(t.chairPositions||["bottom"]).includes(e.value)}),n.textContent="Edit Desk",o.textContent="Save Changes")}else document.getElementById("deskForm").reset(),document.getElementById("editDeskId").value="",document.getElementById("deskFloor").value=deskState.currentFloor,document.getElementById("deskWidth").value=60,document.getElementById("deskHeight").value=40,s.value="hotseat",d.style.display="none",document.querySelectorAll('input[name="chairPos"]').forEach(e=>{e.checked="bottom"===e.value}),n.textContent="Add Desk",o.textContent="Add Desk";t.classList.add("active")}function closeDeskModal(){document.getElementById("deskModal").classList.remove("active"),document.getElementById("deskForm").reset(),document.getElementById("editDeskId").value=""}async function handleDeskSubmit(e){e.preventDefault();const t=document.getElementById("editDeskId").value,n=document.getElementById("deskName").value,o=document.getElementById("deskLocationInput").value,a=document.getElementById("deskFloor").value||deskState.currentFloor,s=document.getElementById("deskZone").value,d=parseInt(document.getElementById("deskWidth").value)||60,l=parseInt(document.getElementById("deskHeight").value)||40,i=document.getElementById("deskType").value,c="team_seat"===i?document.getElementById("assignedTeamId").value:null,r=Array.from(document.querySelectorAll('input[name="chairPos"]:checked')).map(e=>e.value),m=deskState.desks,u=m.length>0?m.length%8*90+50:50,g=m.length>0?80*Math.floor(m.length/8)+80:80,p={name:n,locationId:o,floor:a,zone:s,width:d,height:l,deskType:i,assignedTeamId:c,chairPositions:r};try{let e;if(e=t?await fetch(`/api/desks/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}):await fetch("/api/desks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...p,x:u,y:g})}),!e.ok){const t=await e.json();throw new Error(t.error)}showToast(t?"Desk updated":"Desk created","success"),closeDeskModal(),loadDesks()}catch(e){showToast(e.message||"Failed to save desk","error")}}function editDesk(e){openDeskModal(e)}async function deleteDesk(e){if(confirm("Delete this desk? All bookings for this desk will also be deleted."))try{await fetch(`/api/desks/${e}`,{method:"DELETE"}),showToast("Desk deleted","success"),loadDesks()}catch(e){showToast("Failed to delete desk","error")}}function openRoomModal(e=null){const t=document.getElementById("roomModal"),n=document.getElementById("roomForm");if(e){const t=deskState.floorElements.find(t=>t.id===e);t&&(document.getElementById("editRoomId").value=t.id,document.getElementById("roomLabel").value=t.label||"",document.getElementById("roomWidth").value=t.width||150,document.getElementById("roomHeight").value=t.height||120,document.getElementById("roomColor").value=t.color||"#3b82f6")}else n.reset(),document.getElementById("editRoomId").value="";t.classList.add("active")}function closeRoomModal(){document.getElementById("roomModal").classList.remove("active")}async function handleRoomSubmit(e){e.preventDefault();const t=document.getElementById("editRoomId").value,n=document.getElementById("roomLabel").value,o=parseInt(document.getElementById("roomWidth").value),a=parseInt(document.getElementById("roomHeight").value),s=document.getElementById("roomColor").value,d={type:"room",locationId:state.currentLocation,floor:deskState.currentFloor,label:n,width:o,height:a,color:s,x:50,y:50};try{t?await fetch(`/api/floor-elements/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}):await fetch("/api/floor-elements",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)}),showToast(t?"Room updated":"Room added","success"),closeRoomModal(),loadDesks()}catch(e){showToast("Failed to save room","error")}}function openWallModal(){document.getElementById("wallModal").classList.add("active"),document.getElementById("editWallId").value="",document.getElementById("wallLength").value=100,document.getElementById("wallThickness").value=6,document.querySelector('input[name="wallOrientation"][value="0"]').checked=!0}function closeWallModal(){document.getElementById("wallModal").classList.remove("active"),document.getElementById("wallForm").reset()}async function handleWallSubmit(e){e.preventDefault();const t=parseInt(document.getElementById("wallLength").value)||100,n=parseInt(document.getElementById("wallThickness").value)||6,o=parseInt(document.querySelector('input[name="wallOrientation"]:checked').value)||0,a=document.getElementById("editWallId").value;try{a?(await fetch(`/api/floor-elements/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({width:t,height:n,rotation:o})}),showToast("Wall updated","success")):(await fetch("/api/floor-elements",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"wall",locationId:state.currentLocation,floor:deskState.currentFloor,x:100,y:100,width:t,height:n,rotation:o})}),showToast("Wall added - drag to position","success")),closeWallModal(),loadDesks()}catch(e){showToast("Failed to save wall","error")}}function addWallElement(){openWallModal()}function openLabelModal(e=null){const t=document.getElementById("labelModal"),n=document.getElementById("labelForm");if(e){const t=deskState.floorElements.find(t=>t.id===e);t&&(document.getElementById("editLabelId").value=t.id,document.getElementById("labelText").value=t.label||"")}else n.reset(),document.getElementById("editLabelId").value="";t.classList.add("active")}function closeLabelModal(){document.getElementById("labelModal").classList.remove("active")}async function handleLabelSubmit(e){e.preventDefault();const t=document.getElementById("editLabelId").value,n=document.getElementById("labelText").value,o={type:"label",locationId:state.currentLocation,floor:deskState.currentFloor,label:n,x:100,y:100};try{t?await fetch(`/api/floor-elements/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}):await fetch("/api/floor-elements",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),showToast(t?"Label updated":"Label added","success"),closeLabelModal(),loadDesks()}catch(e){showToast("Failed to save label","error")}}function openDeskBookingModal(e){const t=deskState.desks.find(t=>t.id===e);if(!t)return;const n=document.getElementById("deskBookingModal"),o=document.getElementById("deskBookingInfo"),a=document.getElementById("deskBookingForm"),s=state.locations.find(e=>e.id===t.locationId),d=!!deskState.deskBookings.find(t=>t.deskId===e);if(document.getElementById("bookingDeskId").value=e,document.getElementById("bookingDate").value=deskState.selectedDate,a.style.display=d?"none":"block",!d){const e=localStorage.getItem("employeeName"),t=localStorage.getItem("employeeEmail"),n=localStorage.getItem("employeeTeamId");e&&(document.getElementById("employeeName").value=e),t&&(document.getElementById("employeeEmail").value=t);const o=document.getElementById("deskBookingTeam"),a=[...state.teams].sort((e,t)=>e.name.localeCompare(t.name));o.innerHTML='<option value="">-- No team --</option>'+a.map(e=>`<option value="${e.id}" ${e.id===n?"selected":""} style="color: ${e.color}">${e.name}</option>`).join("")}o.innerHTML=`\n        <h3>${t.name}</h3>\n        <p>${s?.name||""} ${t.floor?`‚Ä¢ Floor ${t.floor}`:""} ${t.zone?`‚Ä¢ ${t.zone}`:""}</p>\n        <p class="booking-date">${new Date(deskState.selectedDate).toLocaleDateString("en-ZA",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</p>\n        <p class="booking-type">${d?"Currently Booked":"Full Day Booking"}</p>\n    `,renderDeskBookingsList(e),n.classList.add("active")}function closeDeskBookingModal(){document.getElementById("deskBookingModal").classList.remove("active"),document.getElementById("deskBookingForm").reset(),document.getElementById("deskBookingForm").style.display="block"}async function handleDeskBookingSubmit(e){e.preventDefault();const t=document.getElementById("bookingDeskId").value,n=document.getElementById("bookingDate").value,o=document.getElementById("employeeName").value,a=document.getElementById("employeeEmail").value,s=document.getElementById("deskBookingTeam").value||null;localStorage.setItem("employeeName",o),a&&localStorage.setItem("employeeEmail",a),s&&localStorage.setItem("employeeTeamId",s);try{const e=await fetch("/api/desk-bookings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deskId:t,date:n,employeeName:o,employeeEmail:a,teamId:s})});if(!e.ok){const t=await e.json();throw new Error(t.error)}showToast("Desk booked for the day!","success");const d=await fetch(`/api/desk-bookings?locationId=${state.currentLocation}&date=${n}`);deskState.deskBookings=await d.json(),closeDeskBookingModal(),renderFloorMap()}catch(e){showToast(e.message||"Failed to book desk","error")}}function renderDeskBookingsList(e){const t=document.getElementById("deskBookingsList"),n=deskState.deskBookings.filter(t=>t.deskId===e);0!==n.length?t.innerHTML=n.map(t=>`\n            <div class="desk-booking-item ${t.checkedIn?"checked-in":""}">\n                <div class="booking-person">${t.employeeName}</div>\n                <div class="booking-duration">Full Day</div>\n                ${t.checkedIn?'<span class="checked-in-badge">Checked In</span>':""}\n                <button class="btn btn-small btn-danger" data-booking-id="${t.id}" data-desk-id="${e}" onclick="cancelDeskBooking(this.dataset.bookingId, this.dataset.deskId)">Cancel</button>\n            </div>\n        `).join(""):t.innerHTML='<p class="hint">No bookings for this day</p>'}async function cancelDeskBooking(e,t){if(confirm("Cancel this booking?"))try{await fetch(`/api/desk-bookings/${e}`,{method:"DELETE"}),showToast("Booking cancelled","success");const n=deskState.selectedDate,o=await fetch(`/api/desk-bookings?locationId=${state.currentLocation}&date=${n}`);deskState.deskBookings=await o.json(),renderDeskBookingsList(t),renderFloorMap(),closeDeskBookingModal()}catch(e){showToast("Failed to cancel booking","error")}}function showDeskQR(e){const t=deskState.desks.find(t=>t.id===e);if(!t)return;const n=`${window.location.origin}/checkin.html?code=${t.qrCode}`,o=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(n)}`,a=document.createElement("div");a.className="modal active",a.id="qrModal",a.innerHTML=`\n        <div class="modal-content modal-small" style="text-align: center;">\n            <div class="modal-header">\n                <h2>QR Code: ${t.name}</h2>\n                <button class="modal-close" onclick="document.getElementById('qrModal').remove()">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </button>\n            </div>\n            <div style="padding: 2rem;">\n                <img src="${o}" alt="QR Code" style="max-width: 200px; border-radius: 8px; background: white; padding: 10px;">\n                <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">\n                    Scan this QR code at the desk to check in\n                </p>\n                <p style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted); word-break: break-all;">\n                    ${n}\n                </p>\n                <button class="btn btn-primary" style="margin-top: 1rem;" onclick="window.open('${o}', '_blank')">\n                    Download QR Code\n                </button>\n            </div>\n        </div>\n    `,a.addEventListener("click",e=>{e.target===a&&a.remove()}),document.body.appendChild(a)}document.addEventListener("DOMContentLoaded",init);